@{
    ViewBag.Title = "XX商城";

}
@section styles{
    <link href="~/Scripts/pbl/fonts/pbl/font-awesome.min.css" rel="stylesheet" />
    <link href="~/Scripts/pbl/fonts/pixelfabric-clothes/style.css" rel="stylesheet" />
    <link href="~/Scripts/pbl/css/demo.css" rel="stylesheet" />
    <link href="~/Scripts/pbl/css/flickity.css" rel="stylesheet" />
    <link href="~/Scripts/pbl/css/component.css" rel="stylesheet" />
    <link href="~/Scripts/camroll_slider/camroll_slider.css" rel="stylesheet" />
    <script src="~/Scripts/pbl/js/modernizr.custom.js"></script>


    <style>
        .el-header {
            display: flex;
            align-items: center;
            background-color: aliceblue;
        }

        body {
            color: #806b6b;
        }

        .div_user {
            width: 10%;
        }

        .txt_right {
            text-align: right;
            margin-bottom: 5px;
        }

        .cart {
            background-color: transparent !important;
            padding: 0px;
            padding-right: 16px;
            position: relative;
            color: #f55f5f;
        }

        .cart__count {
            top: 58%;
            right: 0px;
            background-color: red;
        }

        .el-popover .el-form-item {
            margin-bottom: 0px;
        }

        .no-touch .cart:hover {
            color: red;
        }

        .el-input-number__increase, .el-input-number__decrease {
            width: 20px !important;
        }

        .el-input-number.is-controls-right .el-input__inner {
            padding-right: 25px !important;
            padding-left: 5px !important;
        }

        .cut_ellink > .el-link--inner {
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 177px;
        }

        .div_contentName {
            display: flex;
            height:350px;
        }

        #my-slider {
            flex: 2;
        }

        .elformCl {
            flex: 1.5;
        }

        .div_html img {
            width: 100%;
        }
    </style>

}
<el-container>
    <el-header>
        <div style="flex:1;align-items:center;text-align:center;">
            XX商城
        </div>
        <div class="div_user">
            <i class="el-icon-user">
                <el-link type="danger" v-if="!userInfoForm.userInfo" v-on:click="DialogForm.visible=true">请登录</el-link>
                <template v-else>
                    <el-popover placement="bottom-end"
                                title="用户信息"
                                width="300"
                                trigger="click">
                        <el-form label-width="80px" size="mini">
                            <el-form-item label="账号：">
                                <span>{{userInfoForm.userInfo.AccountNumber}}</span>
                            </el-form-item>
                            <el-form-item label="邮箱：">
                                <span>{{userInfoForm.userInfo.Email}}</span>
                            </el-form-item>
                            <el-form-item label="地址：">
                                <span>{{userInfoForm.userInfo.Address}}</span>
                            </el-form-item>
                        </el-form>
                        <el-link type="danger" slot="reference">{{userInfoForm.userInfo.AccountNumber}}</el-link> 
                        
                    </el-popover>
                </template>
                <template v-if="!!userInfoForm.userInfo">
                    |
                    <el-link type="danger" v-on:click="offLine">注销</el-link>
                </template>
            </i>
            
            <el-popover placement="bottom-end"
                        title="购物车"
                        width="680"
                        trigger="click">
                <div>
                    <el-table v-bind:data="cartData">
                        <el-table-column width="180" prop="SPName" label="商品名称" show-overflow-tooltip>
                            <template slot-scope="scope">
                                <el-link type="primary" class="cut_ellink" v-on:click="showContent(scope.row)">{{scope.row.SPName}}</el-link>
                            </template>
                        </el-table-column>
                        <el-table-column width="150" label="图片">
                            <template slot-scope="scope">
                                <img v-if="scope.row.SPImg.length>0" style="width:120px;height:120px;" v-bind:src="scope.row.SPImg[0].base64" v-bind:alt="scope.row.SPImg[0].filename" />
                            </template>
                        </el-table-column>
                        <el-table-column width="90" label="数量">
                            <template slot-scope="scope">
                                <el-input-number style="width:80px;" v-on:change="onQCountChange" v-bind:precision="0" v-model="scope.row.QCount" type="number" v-bind:min="1" size="mini" controls-position="right"></el-input-number>
                            </template>
                        </el-table-column>
                        <el-table-column width="80" prop="SPUnitPrice" label="单价"></el-table-column>
                        <el-table-column width="80" label="金额">
                            <template slot-scope="scope">
                                {{scope.row.QCount.mul(scope.row.SPUnitPrice)}}
                            </template>
                        </el-table-column>
                        <el-table-column width="50" label="操作">
                            <template slot-scope="scope">
                                <el-button type="danger" size="mini" icon="el-icon-delete" circle v-on:click="removeSP(scope.row)"></el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div style="text-align:right;padding-right:10px;padding-top:10px;">
                    <el-button type="success" v-bind:disabled="!(userInfoForm.userInfo&&cartData.length>0)">提交订单</el-button>
                </div>
                <span class="cart" slot="reference">
                    <i class="cart__icon fa fa-shopping-cart"></i>
                    <span class="cart__count">0</span>
                </span>
            </el-popover>
        </div>
    </el-header>



    <el-main>
        @*<div class="grid">
                <div class="grid__item" v-bind:data-row="JSON.stringify(o)">
                    <div class="action--buy">
                        XXXXXXXXXXXXXXXX
                    </div>
                </div>
            </div>*@
        <div class="view">
            <!-- Blueprint header -->
            <!-- Grid -->
            <section class="grid grid--loading">
                <!-- Loader -->
                <img class="grid__loader" src="~/Scripts/pbl/images/grid.svg" width="60" alt="Loader image" />
                <!-- Grid sizer for a fluid Isotope (Masonry) layout -->
                <div class="grid__sizer"></div>
                <template v-for="(d,index) in MainData">
                    <div class="grid__item dresses" v-bind:data-row="JSON.stringify(d)" v-if="(index%4>0)">
                        <div class="slider">
                            <div class="slider__item" v-for="dimg in d.SPImg"><img v-bind:src="dimg.base64" v-bind:alt="dimg.filename" /></div>
                        </div>
                        <div class="meta">
                            <h3 class="meta__title">{{d.SPName}}</h3>
                            <span class="meta__brand">{{d.SPRemark}}</span>
                            <span class="meta__price">￥{{d.SPUnitPrice}}</span>
                        </div>
                        <button class="action action--button action--buy"><i class="fa fa-shopping-cart"></i></button>
                    </div>
                    <div class="grid__item grid__item--size-a shirts" v-else v-bind:data-row="JSON.stringify(d)">
                        <div class="slider">
                            <div class="slider__item" v-for="dimg in d.SPImg"><img v-bind:src="dimg.base64" v-bind:alt="dimg.filename" /></div>
                        </div>
                        <div class="meta">
                            <h3 class="meta__title">{{d.SPName}}</h3>
                            <span class="meta__brand">{{d.SPRemark}}</span>
                            <span class="meta__price">￥{{d.SPUnitPrice}}</span>
                        </div>
                        <button class="action action--button action--buy"><i class="fa fa-shopping-cart"></i></button>
                    </div>
                </template>

            </section>
            <!-- /grid-->
        </div>

    </el-main>

    <el-dialog v-bind:title="DialogForm.title"
               v-bind:visible.sync="DialogForm.visible"
               width="25%"
               v-bind:close-on-click-modal="false">
        <el-form ref="formInline" :model="DialogForm.formEntity" v-bind:rules="ruleInline" label-width="80px">
            <el-form-item prop="UserID" label="账号：">
                <el-input type="text" v-model="DialogForm.formEntity.UserID" placeholder="请输入账号" prefix-icon="el-icon-user-solid">
                </el-input>
            </el-form-item>
            <el-form-item prop="PassWord" label="密码：">
                <el-input type="password" v-model="DialogForm.formEntity.PassWord" placeholder="请输入密码" prefix-icon="el-icon-lock">
                </el-input>
            </el-form-item>
            <el-form-item class="txt_right">
                <el-button v-on:click="onLogin" v-bind:loading="loading" type="primary" size="medium">登陆</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>


    <el-dialog title="商品信息"
               v-bind:visible.sync="dialogSubmit.visible"
               width="50%"
                
               v-bind:close-on-click-modal="false">
        <div class="div_contentName">
            <div id="my-slider" class="crs-wrap">
                <div class="crs-screen">
                    <div class="crs-screen-roll">
                        <div class="crs-screen-item" v-bind:style="{'background-image': 'url('+d.base64+')'}" v-for="(d,index) in dialogSubmit.Form.SPImg">
                            @*<div class="crs-screen-item-content"><h1>{{d.filename}}</h1></div>*@
                        </div>
                    </div>
                </div>
                <div class="crs-bar">
                    <div class="crs-bar-roll-current"></div>
                    <div class="crs-bar-roll-wrap">
                        <div class="crs-bar-roll">
                            <div class="crs-bar-roll-item" v-bind:style="{'background-image': 'url('+d.base64+')'}" v-for="(d,index) in dialogSubmit.Form.SPImg"></div>
                        </div>
                    </div>
                </div>
            </div>

            <el-form label-width="80px" class="elformCl">
                <el-form-item label="商品名称" >
                    {{dialogSubmit.Form.SPName}}
                </el-form-item>
                <el-form-item label="商品简介">
                    {{dialogSubmit.Form.SPRemark}}
                </el-form-item>               
            </el-form>

        </div>
        <p>商品详情</p>
        <div v-html="dialogSubmit.Form.SPDetails" class="div_html"></div>
    </el-dialog>
</el-container>



@section scripts{
    <script src="~/Scripts/jquery.cookie.js"></script>
    <script src="~/Scripts/camroll_slider/camroll_slider.js"></script>
    <script>
        /**
 ** 乘法函数，用来得到精确的乘法结果
 ** 说明：javascript的乘法结果会有误差，在两个浮点数相乘的时候会比较明显。这个函数返回较为精确的乘法结果。
 ** 调用：accMul(arg1,arg2)
 ** 返回值：arg1乘以 arg2的精确结果
 **/
        function accMul(arg1, arg2) {
            var m = 0, s1 = arg1.toString(), s2 = arg2.toString();
            try {
                m += s1.split(".")[1].length;
            }
            catch (e) {
            }
            try {
                m += s2.split(".")[1].length;
            }
            catch (e) {
            }
            return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
        }

        // 给Number类型增加一个mul方法，调用起来更加方便。
        Number.prototype.mul = function (arg) {
            return accMul(arg, this);
        };

        $.extend(vue_data, {
            dialogSubmit: {
                visible: false,
                Form: {

                }
            },
            MainData: [],
            DialogForm: {
                title: '登录',
                visible: false,
                formEntity: {
                    UserID: '',
                    PassWord: ''
                }
            },
            ruleInline: {
                UserID: [{ required: true, message: '请输入登录账号!', trigger: 'blur' },
                { type: 'string', min: 4, message: '账号至少4位!', trigger: 'change blur' }],
                PassWord: [
                    { required: true, message: '请输入密码!', trigger: 'blur' },

                ],
            },
            loading: false,
            userInfoForm: {
                userInfo: null

            },
            cartData: []


        });

        $.extend(vue_methods, {
            showContent: function (rowData) {
                var t = vue_data.dialogSubmit.Form;
                for (var i in rowData) {
                    t[i] = rowData[i];
                }
                vue_data.dialogSubmit.visible = true;
                this.$nextTick(function () {
                    $("#my-slider").camRollSlider();
                });
            },
            onQCountChange: function (currentValue, oldValue) {
                var cartC = $(".cart__count");
                cartC.html((cartC.html() * 1) + currentValue - oldValue);

            },
            removeSP: function (rowData) {
                var QCount = 0;
                for (var i = 0; i < vue_data.cartData.length; i++) {
                    if (vue_data.cartData[i].SPID == rowData.SPID) {
                        QCount = vue_data.cartData[i].QCount;
                        vue_data.cartData.splice(i, 1);
                        break;
                    }
                }
                var cartC = $(".cart__count");
                cartC.html((cartC.html() * 1) - QCount);
            },
            onLogin: function () {
                var self = this;
                self.$refs["formInline"].validate((valid) => {
                    if (!valid) {
                        return;
                    }
                    self.loading = true;
                    //url, paras, type, success, error, complete, beforeSend, async
                    $.cutPost('@Url.Action("Login", "AdminHome")', self.DialogForm.formEntity, function (msg) {
                        self.userInfoForm.userInfo = msg.Data;
                        var expiresDate = new Date();
                        expiresDate.setTime(expiresDate.getTime() + (4 * 60 * 60 * 1000));
                        $.cookie("userinfo", JSON.stringify(msg.Data), { expires: expiresDate });
                        self.$message.success("登录成功...");
                        self.DialogForm.visible = false;
                         
                    }, null, function () {
                        self.loading = false;
                    });
                })
            },
            offLine: function () {
                var self = this;
                self.pageLoading = true;

                $.cutPost('@Url.Action("offLine", "AdminHome")', null, function (msg) {
                    self.userInfoForm.userInfo = null;
                    $.removeCookie("userinfo")
                    self.$message.success("注销成功!");
                }, null, function () {
                    self.pageLoading = false;
                });
            }

        });

        function addToCartEvent(d) {
            var row = $(d).parents(".grid__item").data("row");
            if (!row && (row = JSON.parse(row))) {
                $Vue.$message.error('添加商品异常!');
                return false;
            }

            var d = vue_data.cartData.find(function (a) { return a.SPID == row.SPID });
            if (d) {
                d.QCount++;
            } else {
                row.QCount = 1;
                vue_data.cartData.push(row);
            }
            return true;
        }

        function loadjs() {
            var sc = document.createElement("script");
            sc.src = '@Url.Content("~/Scripts/pbl/js/isotope.pkgd.min.js")';
            $(sc).appendTo('body');
            sc = document.createElement("script");
            sc.src = '@Url.Content("~/Scripts/pbl/js/flickity.pkgd.min.js")';
            $(sc).appendTo('body');
            sc = document.createElement("script");
            sc.src = '@Url.Content("~/Scripts/pbl/js/main.js")';
            $(sc).appendTo('body');
        }

        $.extend(vue_mounted, {
            getUserInfo: function () {
                var u = $.cookie("userinfo");
                if (u) {
                    this.userInfoForm.userInfo = JSON.parse(u);
                } else {
                    this.userInfoForm.userInfo = null;// { AccountNumber: 'ZH0001', Email: 'xx@xx.com', Address: 'xx省xx市大待' };
                }

            },
            LoadSP: function () {

                var self = this;
                self.pageLoading = true;
                $.cutPost('@Url.Action("onSearch", "AdminHome")', { SPName: '' }, function (msg) {
                    var c;
                    for (var i = 0; i < msg.Data.length; i++) {
                        c = msg.Data[i];
                        c.SPImg = JSON.parse(c.SPImg);
                    }
                    self.MainData = msg.Data;
                    self.$nextTick(function () {
                        loadjs();
                    });
                }, null, function () {
                    self.pageLoading = false;
                })
            }

        });
    </script>


}